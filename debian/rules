#!/usr/bin/make -f

export DPKG_GENSYMBOLS_CHECK_LEVEL = 4

FLAVOURS = gtk2 gtk3

export DEB_BUILD_MAINT_OPTIONS = hardening=+all
DPKG_EXPORT_BUILDFLAGS = 1
include /usr/share/dpkg/buildflags.mk

COMMON_CONFIGURE_FLAGS = -DENABLE_TESTS=ON -DENABLE_COVERAGE=OFF

CONFIGURE_FLAGS_gtk3 = -DFLAVOUR_GTK3=ON
CONFIGURE_FLAGS_gtk4 = -DFLAVOUR_GTK4=ON

%:
	dh $@

override_dh_auto_configure: $(FLAVOURS:%=doconfigure-%)

doconfigure-%:
	DH_VERBOSE=1 dh_auto_configure --builddirectory=builddir/$* -- $(COMMON_CONFIGURE_FLAGS) $(CONFIGURE_FLAGS_$*)


override_dh_auto_build: $(FLAVOURS:%=dobuild-%)

dobuild-%:
	dh_auto_build --builddirectory=builddir/$*

override_dh_auto_test:
	xvfb-run -a dh_auto_test --no-parallel --builddirectory=builddir/gtk2
	xvfb-run -a dh_auto_test --no-parallel --builddirectory=builddir/gtk3

override_dh_auto_install: $(FLAVOURS:%=doinstall-%)

doinstall-%:
	dh_auto_install --builddirectory=builddir/$* --destdir=debian/tmp/$*

override_dh_install:
	find debian/tmp -name \*.la -delete
	dh_install -plibayatana-ido3-0.4     --sourcedir=debian/tmp/gtk3
	dh_install -plibayatana-ido3-dev     --sourcedir=debian/tmp/gtk3
	dh_install -pgir1.2-ayatanaido3-0.4  --sourcedir=debian/tmp/gtk3
	dh_install -plibayatana-ido4-0.4     --sourcedir=debian/tmp/gtk4
	dh_install -plibayatana-ido4-dev     --sourcedir=debian/tmp/gtk4
	dh_install -pgir1.2-ayatanaido4-0.4  --sourcedir=debian/tmp/gtk4

override_dh_missing:
	dh_missing -plibayatana-ido3-0.4     --sourcedir=debian/tmp/gtk3
	dh_missing -plibayatana-ido3-dev     --sourcedir=debian/tmp/gtk3
	dh_missing -pgir1.2-ayatanaido3-0.4  --sourcedir=debian/tmp/gtk3
	dh_missing -plibayatana-ido4-0.4     --sourcedir=debian/tmp/gtk4
	dh_missing -plibayatana-ido4-dev     --sourcedir=debian/tmp/gtk4
	dh_missing -pgir1.2-ayatanaido4-0.4  --sourcedir=debian/tmp/gtk4

override_dh_makeshlibs:
        dh_makeshlibs -plibayatana-ido3-0.4 -V 'libayatana-ido3-0.4 (>= 0.9.90)'
        dh_makeshlibs -plibayatana-ido4-0.4 -V 'libayatana-ido4-0.4 (>= 0.9.90)'

get-orig-source:
	uscan --noconf --force-download --rename --download-current-version --destdir=..
